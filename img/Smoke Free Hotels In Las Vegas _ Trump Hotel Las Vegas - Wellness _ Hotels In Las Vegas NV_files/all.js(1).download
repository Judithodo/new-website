(function($){$.fn.mapBox=function(options){var settings=$.extend({dataSource:'/poi',mapType:'poi',mapTypeShow:'cats',mapStyle:'road',disableDefaultUI:false,mapTypeControl:true,mapTypeControlOptions:{style:'default'},scrollwheel:true,zoomControl:true,zoomControlOptions:{style:'default'},scaleControl:true,styledMap:false,printPoints:true,needsIntl:false,featuredCategory:'hotel',hideCategory:'none',printFeatureFirst:false,activeCatOnly:true,showPoiID:true,showPinID:true,hover:false,zoom:7,changeViewOnZoom:true,zoomedView:{type:'road',level:9},minZoom:3,centerPoint:1,useBestView:true,excludeFeaturedCategory:true,disableShadows:false,resetViewOnCategoryChange:true,infoBoxOptions:{alignBottom:false,disableAutoPan:false,maxWidth:0,horizontalOffset:0,verticalOffset:0,zIndex:null,infoBoxClass:'window-feature',boxStyle:{width:'380px'},closeBoxMargin:'2px',closeBoxURL:'/templates/main/images/map/btn-close-info.png',horizontalClearance:25,verticalClearance:25,isHidden:false,usePlacesData:false,pane:'floatPane',enableEventPropagation:false,addDirections:false,directionsType:'link'},infoBoxHtmlOptions:{useTitle:true,useDescription:true,useWebsite:true,useRate:false,useAddress:false,useLocation:false,useImage:true,},styles:{featureType:"poi",stylers:[{visibility:"off"}]},imgPath:'/',mapBoxId:'map',},options);return this.each(function(){var thisMap=$(this);var mapWrapper=$(this).parents('.map-wrapper');var map,items=[],categories=[],catArray=[],longcats=[],longCatArray=[],hashURL,property,start=true,loadIds=null,bounds,maptype,poiID,bounds,mapId=id=$(this).attr('id'),mapType=settings.mapType,popups=[],markers=[];var infoWindow="";var infoBox="";var layers=new Object();var centerArray=new Array();var queryArray=new Array();var pinLayers=new Object();var mapStyle,mapControlOptions,zoomOptions,zoomedViewType;mapWrapper.addClass('type-'+mapType).addClass('type-'+settings.mapTypeShow);mapWrapper.find('.cat-menu').click(function(e){e.preventDefault();mapWrapper.find('.category-wrapper').toggleClass('active');$(this).toggleClass('active');});getData();$(window).unload(function(){if(this._map){this._map.Dispose();}});function getData(){var obj=this;$.getJSON(settings.dataSource,function(data){$.each(data,function(i){items[i]={};var data_id=$(this),id=data_id[0]['@attributes'].id,rate=data_id[0].rate?data_id[0].rate:null,currency=data_id[0].currency?data_id[0].currency:null,image=data_id[0].images[0]?data_id[0].images[0].full:null,title=data_id[0]['@attributes'].title,short_title=data_id[0]['@attributes'].short_title,location=(data_id[0].location===null)?null:data_id[0].location,category=data_id[0].category?data_id[0].category:null,desc=data_id[0].description,address=data_id[0].address?data_id[0].address:null,website=data_id[0].website,georss=data_id[0]['@attributes'].georss_point.length?data_id[0]['@attributes'].georss_point:null;if(georss!==null){items[i].image=image;items[i].id=id;items[i].rate=rate;items[i].currency=currency;items[i].currencySymbol='$';items[i].title=title;items[i].short_title=short_title;items[i].location=location;items[i].description=desc;items[i].website=website;items[i].address=address;items[i].georss=georss;items[i].poiID=i;switch(currency){case 'EUR':items[i].currencySymbol='€';break;case 'CAD':items[i].currencySymbol='$';break;case 'BRL':items[i].currencySymbol='$';break;case 'GBP':items[i].currencySymbol='£';break;}
var catName=[],longName=[];if(typeof(category)==='object'){catName=[];longName=[];$.each(category,function(j,val){if(settings.needsIntl===true){var tempCatName=val.replace(/\s/g,'').replace('&','');}else{var tempCatName=val.replace(/\W/g,'').toLowerCase();}
var longCatName=val.replace(/^\s+|\s+$/g,'');catName.push(tempCatName);longName.push(longCatName);});}else{catName=[];longName=[];if(settings.needsIntl===true){var tempCatName=category.replace(/\s/g,'').replace('&','');}else{var tempCatName=category.replace(/\W/g,'').toLowerCase();}
var longCatName=category.replace(/^\s+|\s+$/g,'');catName.push(tempCatName);longName.push(longCatName);}
items[i].category=catName;items[i].longName=longName;}});createMap();});}
function createMap(){console.log(settings.mapboxName);var fp=getLatLong(items[items.length-1]['georss']);var latlng=fp;var mapOptions={container:settings.mapBoxId,zoom:settings.zoom,scrollZoom:true,style:'mapbox://styles/mapbox/streets-v11',center:latlng,};map=new mapboxgl.Map(mapOptions);map.addControl(new mapboxgl.NavigationControl({showCompass:false}),'bottom-right');var marker=new mapboxgl.Marker();var userLocation;var browserSupportFlag=new Boolean();if(settings.useGeo===true){if(navigator.geolocation){browserSupportFlag=true;navigator.geolocation.getCurrentPosition(function(position){var posLat=position.coords.latitude;var posLong=position.coords.longitude;userLocation=new mapboxgl.LngLat(position.coords.latitude,position.coords.longitude);map.setCenter(userLocation);},function(){handleNoGeolocation(browserSupportFlag);});}
else{browserSupportFlag=false;handleNoGeolocation(browserSupportFlag);}
function handleNoGeolocation(errorFlag){if(errorFlag==true){alert("Geolocation service failed.");}else{alert("Your browser doesn't support geolocation.");}}
function successCallback(position){var latitude=position.coords.latitude;var longitude=position.coords.longitude;}
function errorCallback(error){console.log('error')}
if(Modernizr.geolocation){navigator.geolocation.getCurrentPosition(successCallback,errorCallback,{maximumAge:0});}else{}}
getCategories();var styles=[[{url:'/templates/main/images/svgs/map-cluster-pin.svg',height:35,width:35,textColor:'#ffffff'}]];var mcOptions={styles:styles[0],gridSize:10};if(settings.featuredCategory!='hotel'){map.setCenter(new mapboxgl.LngLat(40.979898069620155,11.25));}
var q=String(hashURL);q=q.split('?');q=q[1];if(q!=undefined){var query=parseQuery(q);if(query.id!==null&&query.id!==undefined){loadIds=query.id.split(',');}
viewQuery(loadIds);}
map.on('zoom',function(){closeInfoWindows();});start=false;}
function viewQuery(loadIds){$.each(loadIds,function(k,val2){$.each(items,function(j){if(items[j].id==val2){queryArray.push(j);}});});if(queryArray.length==1){var j=queryArray[0];if(items[j].category==settings.featuredCategory){var qID=items[j].id;var loc=getCenterPoint(j);currentID=qID;l=layers[qID];$('div#feature-list-'+qID).addClass('on');map.setOptions({center:loc,zoom:10});}else{var cat=items[queryArray[0]].category;loadPoints(cat);var loc=getCenterPoint(j);map.setOptions({center:loc,zoom:10});}}else if(queryArray.length>1){var cat=items[queryArray[0]].category;loadPoints(cat);}}
function getCategories(){var obj=this,divFeatureWrapper=$('<div />').attr('id','feature-wrapper'),divFeature=$('<div />').attr('id','feature-points');$.each(items,function(i,val){if(settings.centerPoint==items[i].id)centerPoint=i;var dup=false
longDup=false;catArray=items[i].category;longCatArray=items[i].longName;for(x in catArray){dup=false;$.each(categories,function(j,val2){if(catArray[x]==val2){dup=true;}});if(!window.one){window.one=[];}
window.one.push(val);if((catArray[x]==settings.featuredCategory)&&(mapType!='poi')){loadfeaturepoints(val.id);var anchorFeat=$('<a />').attr({'href':'#','class':'feat-link'}).html(val.title).click(function(e){showFeaturePoint(items[i].id,settings.featuredCategory);return false;});$('<div />').addClass('feature-list').attr('id','feature-list-'+val.id).html(anchorFeat).click(function(e){loadfeaturepoints(val.id);return false;}).appendTo(divFeature);$('div.feature-list').mouseover(function(){$(this).addClass('featurehover');});$('div.feature-list').mouseout(function(){$(this).removeClass('featurehover');});}
if(!dup){categories.push(catArray[x]);}}
for(y in longCatArray){longDup=false;$.each(longcats,function(j,val2){if(longCatArray[y]==val2){longDup=true;}});if(!longDup){longcats.push(longCatArray[y]);}}});if((mapType=='both')&&(settings.printFeatureFirst!=undefined)&&(settings.printFeatureFirst===true)){$(divFeatureWrapper).append(divFeature);mapWrapper.append(divFeatureWrapper);printCategories();}else{if(mapType!='feature'){printCategories();}
if((mapType=='both')||(mapType=='feature')){$(divFeatureWrapper).append(divFeature);mapWrapper.append(divFeatureWrapper);}}
if(mapType!='poi')
setBestView();}
function printCategories(){var divWrapper=$('<div />').attr('class','category-wrapper'),div=$('<div />').attr('class','categories'),letterIdx=0;$.each(categories,function(i,val){var testsub=val.toString().substring(0,4),excludeCat=false,theLetter='';if(settings.excludeFeaturedCategory===true&&val===settings.featuredCategory){excludeCat=true;letterIdx++;}
theLetter=String.fromCharCode(i+65-letterIdx);if((((val!=='property')&&(val!=='featurepoint'))&&(excludeCat!==true))&&testsub!=='func'){var divCat=$('<div />').addClass('category').attr('id',val).attr('data-index',theLetter).click(function(e){mapWrapper.find('.categories').addClass('move');e.preventDefault();closeInfoWindows();if(settings.activeCatOnly===true){$(this).siblings('.on').trigger('click');}
$(this).addClass('on');if($(this).find('.point-list li').length>9||(window.orientation!=0&&$(this).find('.point-list li').length>6)){$(this).addClass('tall');}else{$(this).removeClass('tall');}
loadPoints(val);return false;}).appendTo(div);longcats[i]=longcats[i].replace('/',' / ');var anchorCat=$('<a />').attr({'href':'#','id':'map-category-'+i,'class':'cat-link map-category'}).html(longcats[i]).appendTo(divCat);if(settings.printPoints===true){printPoints(val,divCat);}
$('div.category').mouseover(function(){$(this).addClass('hover');});$('div.category').mouseout(function(){$(this).removeClass('hover');});}});$(divWrapper).append(div);mapWrapper.append(divWrapper);if((settings.featuredCategory!==undefined)){if(settings.featuredCategory==='all'){$.each(categories,function(i,val){loadPoints(val);if(val!=settings.hideCategory)
$('div#'+val).addClass('on');else
$('div#'+val).hide();});setBestView();}else{loadPoints(settings.featuredCategory);$('div#'+settings.featuredCategory).addClass('on');}}}
function printPoints(cat,divCat){var obj=this,cats=cat===null?categories:[cat],catName='',pointUl=$('<ul />').attr('id','point-list-'+cat).addClass('point-list'),listLetter=divCat.data('index');pointUl.prepend('<li class="back-to js-generated"><a href="#">'+mapWrapper.data('back-text')+'</a></li>');$.each(cats,function(i,val){layers[val]=new Array;$.each(items,function(j){var catSelectedArray=new Array();var currarray=String(items[j].category);catSelectedArray=currarray.split(",");for(x in catSelectedArray){var point;point=items[j]['georss'];if((catSelectedArray[x]==val)&&point!=''){var pointLi=$('<li />').attr('id',cat+'-'+items[j].id);var listHtml=items[j].title;if(settings.showPoiID===true){listHtml='<span class="list-pin">'+items[j].poiID+'</span><em class="list-name">'+items[j].title+'</em>';}
var pointAnchor=$('<a />').attr({'href':'#','id':cat+'-'+items[j].id}).html(listHtml).click(function(){$(this).parent().siblings().find('a').removeClass('active');$(this).addClass('active');showSinglePoint(items[j].id,cat);mapWrapper.find('.category-wrapper').toggleClass('active');$('.cat-menu').toggleClass('active');return false;});$(pointLi).append(pointAnchor);$(pointUl).append(pointLi);}}});});$(pointUl).find('li').each(function(){var listPos=$(this).parent().children().index(this),pinLabelType=(settings.pinLabelType),pinLabelChar=(settings.pinLabelChar);if(pinLabelType==='list'){if(pinLabelChar==='letter'){listPos=String.fromCharCode(64+listPos);}
$(this).find('a span').html(listLetter+listPos);}
$(this).addClass('pos-'+listPos);});$(divCat).append(pointUl);}
function loadPoints(cat){var obj=this;var cats=cat===null?categories:[cat];var notMade=checkLayers(cat);var catName='';if(notMade){$.each(cats,function(i,val){layers[val]=new Array;var shapes=[];if(loadIds!==null){$.each(loadIds,function(k,val2){$.each(items,function(j){if(items[j].id==val2){var d=addPOIPoint(shapes,j,cat,'qstring');var loc=getCenterPoint(j);centerArray.push(loc);}});});}else{$.each(items,function(j){var catSelectedArray=new Array();var currarray=String(items[j].category);catSelectedArray=currarray.split(",");for(x in catSelectedArray){if(catSelectedArray[x]==val){var d=addPOIPoint(shapes,j,cat,layers[val]);layers[val].push(d);var loc=getCenterPoint(j);centerArray.push(loc);}}});}
if((cat!='property')&&(cat!='featurepoint')){$('.feature-list').each(function(){if($(this).hasClass('on')){var featureid=$(this).attr('id').toString().substr(13);l=layers[featureid];var pinidx=getPinIndex(featureid);$('div#feature-list-'+featureid).removeClass('on');$('div#feature-list-'+featureid).addClass('off');$(this).removeClass('on');}});}
loadIds=null;if(settings.resetViewOnCategoryChange===true&&start===false){setBestView();}});}}
function showSinglePoint(idx,cat){tempL=layers[cat];$.each(tempL,function(i,val){var tempPoint=val;if(tempPoint.pinID.toString()==idx.toString()){map.flyTo({center:tempPoint._lngLat,zoom:settings.zoomedView.level});setTimeout(function(){$('.markerid-'+tempPoint.pinID).trigger('click');},1500);$('.markerid-'+tempPoint.pinID).trigger('click');}});}
function loadfeaturepoints(featureid){var obj=this;featureid=featureid.toString();var notMade=checkfeaturepoints(featureid);if(notMade){bounds=new google.maps.LatLngBounds();var shapes=[];$.each(items,function(j){if(featureid==items[j].id){var d=addfeaturePoint(shapes,j,'featurepoint');layers[featureid]=d;var loc=getCenterPoint(j);centerArray.push(loc);}});}}
function checkLayers(cat){var obj=this;entityIdx=pinLayers[cat];l=layers[cat];if((l!=undefined)&&(l.length!=0)){if(getVisible(l[0])){if($('div#'+cat).children('.cat-link').is(':visible')){$('div#'+cat).removeClass('on');mapWrapper.find('.categories').removeClass('move');}}else{if((cat!='property')&&(cat!='featurepoint')){$('.feature-list').each(function(){if($(this).hasClass('on')){var featureid=$(this).attr('id').toString().substr(13);var pinidx=getPinIndex(featureid);l2=layers[featureid];$('div#feature-list-'+featureid).removeClass('on');$('div#feature-list-'+featureid).addClass('off');$(this).removeClass('on');}});var cats=cat===null?categories:[cat];$.each(cats,function(i,val){var shapes=[];$.each(items,function(j){var catSelectedArray=new Array();var currarray=String(items[j].category);catSelectedArray=currarray.split(",");for(x in catSelectedArray){if(catSelectedArray[x]==val){var loc=getCenterPoint(j);centerArray.push(loc);}}});});centerArray=uniqueArray(centerArray);setBestView();}
$('div#'+cat).removeClass('off');$('div#'+cat).addClass('on');}
if($('div#'+cat).children('.cat-link').is(':visible')){for(i=0;i<l.length;i++){if(l[i]!=undefined){if(getVisible(l[i])==true){setVisible(l[i],false);}else{setVisible(l[i],true);}}}}
return false;}
return true;}
function checkfeaturepoints(featureid){featureid=featureid.toString();l=layers[featureid];if(l!=undefined){if(l.getVisible()){if($('div#feature-list-'+featureid).hasClass('on')==false){var obj=this;$.each(items,function(j){if(featureid==items[j].id){featureid=parseFloat(featureid);var point;point=getLatLong(items[j]['georss']);var loc=new google.maps.LatLng(parseFloat(point[0]),parseFloat(point[1]));map.setOptions({center:loc,zoom:16});currentID=featureid;$('div#feature-list-'+featureid).addClass('on');}});}else{var obj=this;var pinidx=getPinIndex(featureid);$('div#feature-list-'+featureid).removeClass('on');$('div#feature-list-'+featureid).addClass('off');}
$('.feature-list').each(function(){var featureon=$(this).attr('id').toString().substr(13);if($(this).hasClass('on')&&(featureon!=featureid)){var pinidx=getPinIndex(featureon);l2=layers[featureon];$(this).removeClass('on');}});}else{var marker=createMarker(latLng,items[i].property_name,items[i].address,i,items[i].property_style);}
return false;}
return true;}
function addPOIPoint(shapes,j,cat,cstm){var info='';var point=getLatLong(items[j]['georss']);if(point!=''&point!='null,null'){var loc=new mapboxgl.LngLat(parseFloat(point[0]),parseFloat(point[1]));if(items[j].category.length>1){var pushpinOptions={icon:settings.imgPath+'images/map/pins/star.gif',width:31,height:46,id:j.toString(),typeName:j.toString()};}else{var pushpinOptions={icon:settings.imgPath+'images/map/pins/'+items[j].category+'.png',width:20,height:24,id:j.toString(),typeName:j.toString()};}
var marker=createMarker(cat,loc,j);markers.push(marker);if(cat=='hotel'&&mapType=='poi'){$('.markerid-'+items[j]['id']).trigger('click');}
return marker;}}
function addfeaturePoint(shapes,j,cat,cstm){var info='';var point=getLatLong(items[j]['georss']);if(point!=''&point!='null,null'){var loc=new mapboxgl.LngLat(parseFloat(point[0]),parseFloat(point[1]));var marker=createMarker(cat,loc,j);return marker;}}
function getLatLong(point){var lanlat=point.split(' ');var pts=[lanlat[1],lanlat[0]];return pts;}
function getCenterPoint(j){var centerPoint=getLatLong(items[j]['georss']);if(centerPoint!=''&centerPoint!='null,null'){return loc=new mapboxgl.LngLat(parseFloat(centerPoint[0]),parseFloat(centerPoint[1]));}else{return false;}}
function setBestView(){if(settings.useBestView){bounds=new mapboxgl.LngLatBounds();for(var i=0;i<centerArray.length;i++){if(centerArray[i]!=false)
bounds.extend(centerArray[i]);}
map.fitBounds(bounds);centerArray.length=0;}}
function getPinIndex(featureid){var pinidx;$.each(items,function(j){if(featureid==items[j].id){pinidx=j;}});return pinidx;}
function parseQuery(str){var vars=str.split("&");var pairs={};for(var i=0;i<vars.length;i++){var p=vars[i].split("=");pairs[p[0]]=this.urlDecode(p[1]);}
return pairs;}
function urlDecode(encodedString){var output=encodedString;var binVal,thisString;var myregexp=/(%[^%]{2})/;while((match=myregexp.exec(output))!==null&&match.length>1&&match[1]!==''){binVal=parseInt(match[1].substr(1),16);thisString=String.fromCharCode(binVal);output=output.replace(match[1],thisString);}
return output;}
function createMarker(cat,latlng,idx,cstm){var name=items[idx].property_name;var address=items[idx].address;var m=items[idx].category;var mCat='';$.each(m,function(i){mCat+=' marker-cat-'+m[i];});if(m[0]!='hotel'){var catListPos=mapWrapper.find('.category ul').find('li[id="'+m+'-'+items[idx].id+'"]').attr('class').split('-');catListPos=catListPos[1];}
var letter=$('.category[id="'+m+'"]').attr('data-index');var markerContent=document.createElement('DIV');if(settings.showPinID===true){markerContent.innerHTML='<div class="pin-marker '+mCat+' markerid-'+items[idx].id+'" data-pinID="'+items[idx].id+'" tabindex="0" onkeypress="javascript: if(event.keyCode == 13) $(this).click();"><div class="pin-label">'+letter+catListPos+'</div></div>';}else{markerContent.innerHTML='<div class="pin-marker marker-cat-'+items[idx].category+' marker-'+items[idx].id+'"  data-pinID="'+items[idx].id+'" tabindex="0"></div>';}
markerContent.pinID=items[idx].id;latlng=getLatLong(items[idx].georss);var marker=new mapboxgl.Marker(markerContent,{offset:[0,-15]}).setLngLat(latlng).addTo(map);marker.id=idx;marker.pinID=items[idx].id;marker.category=cat;marker.show=true;markerContent.addEventListener('click',function(e){closeInfoWindows();console.log('click event for pin')
var latlng=getCenterPoint(idx);var hotelAddress;var html;var request={location:latlng,radius:1};$('.point-list li a').removeClass('active');$('.point-list li#'+items[idx].category+'-'+items[idx].id+' a').addClass('active');html='';html=getInfoWindowContent(idx,{},html);var boxText=document.createElement('div');if(boxText[0])boxText[0].remove();var popup=new mapboxgl.Popup({closeOnClick:false}).setLngLat([latlng.lng,latlng.lat]).setHTML(html).addTo(map);setTimeout(function(){boxText.focus();},1000);});$('.pin-marker').keydown(function(e){var key=e.which||e.keyCode;if(key===13){console.log('enter key pin marker');}});markerContent.addEventListener('keypress',function(e){console.log('keypress');var key=e.which||e.keyCode;if(key===13){console.log('enter key');}});if(settings.infoBoxOptions.infoBoxClass!='window-feature'){var windowTrigger;if(settings.hover!=undefined&&settings.hover==true){windowTrigger='mouseover';}else{windowTrigger='click';}
google.maps.event.addListener(marker,((navigator.platform=='iPad')?'click':windowTrigger),function(){closeInfoWindows();var latlng=getCenterPoint(idx);var hotelAddress;var html;var request={location:latlng,radius:1};var service=new google.maps.places.PlacesService(map);service.search(request,function(results,status){if(status==google.maps.places.PlacesServiceStatus.OK){token=results[0].reference;var placeRequest={reference:token};var placeService=new google.maps.places.PlacesService(map);placeService.getDetails(placeRequest,function(place,status){if(status==google.maps.places.PlacesServiceStatus.OK){html='';html=getInfoWindowContent(idx,place,html);var boxText=document.createElement("div");boxText.innerHTML=html;infoBox.setOptions(settings.infoBoxOptions);infoBox.setContent(boxText);infoBox.open(map,marker);}});}});});}
return marker;}
function closeInfoWindows(){$('.mapboxgl-popup').remove();}
function getInfoWindowContent(idx,place,html){var w=items[idx].category;var wCat='';var winW=$(window).width();if(winW>1024){var l=350;}else{var l=250;}
var desc=items[idx].description;var shortDesc=(desc.length)?desc.substring(0,l):'';var descL=desc.length;$.each(w,function(i){wCat+=' win-cat-'+w[i];});html+='<div class="infoWindow">';html+='<div class="infoWindowContent '+wCat+' win-'+items[idx].id+'">';html+='<a class="close-box" tabindex="0" onclick="$(this).closest(\'.infoBox\').hide();$(\'#ourhotelsmenu-mapview\').focus();" onkeypress="javascript: if(event.keyCode == 13) $(this).click();"><span class="close-elem"></span></a>';$.each(items[idx],function(k,val2){if((val2!='')&&(val2!=undefined)){switch(k){case 'title':if(settings.infoBoxHtmlOptions.useTitle===true)
html+='<h4 class="sectiontitle">'+items[idx].short_title+'';if(settings.infoBoxHtmlOptions.useLocation===true&&items[idx].location!=null)
html+='<span class="smaller">'+items[idx].location+'</span>';if(settings.featuredCategory==='hotel'&&items[idx].address!=null)
html+='<span class="smaller">'+items[idx].address+'</span>';html+='</h4>';break;case 'image':if(settings.infoBoxHtmlOptions.useImage===true&&items[idx].image!=null&&items[idx].image.length>0){html+='<div class="inset"><img src="'+items[idx].image+'" alt="" / ></div>';}
break;case 'address':if(settings.infoBoxHtmlOptions.useAddress===true&&items[idx].address!=null)
html+='<p>'+items[idx].address+'</p>';break;case 'description':if(settings.infoBoxHtmlOptions.useDescription===true&&items[idx].description!=null)
if(descL>l){html+='<div class="description">'+shortDesc+'... </div>';}else{html+='<div class="description">'+items[idx].description+'</div>';}
break;case 'website':if(settings.infoBoxHtmlOptions.useWebsite===true&&items[idx].website!==null)
var text=$('.MapContainer').data('visit');if(items[idx].category[0]!='hotel'){html+='<a tabindex="0" class="website button secondary hollow"';if(settings.featuredCategory=='hotel'){html+=' target="_blank" href="'+items[idx].website+'">'+text+'</a>';}else{html+=' href="/'+items[idx].website+'">'+text+'</a>';}}
break;case 'rate':if(settings.infoBoxHtmlOptions.useRate===true&&items[idx].rate!=null)
html+='<div class="rate"><i>from</i> '+items[idx].currencySymbol+items[idx].rate+' '+items[idx].currency+'/Night</div>';break;}}else{switch(k){case 'title':if(settings.infoBoxHtmlOptions.useTitle===true)
html+='<h4>'+place.name+'</h4>';break;case 'image':if(settings.infoBoxHtmlOptions.useImage===true&&items[idx].image!=null&&items[idx].image.length>0)
html+='<div class="inset"><img src="'+items[idx].image+'" alt="" / ></div>';break;case 'address':if(settings.infoBoxHtmlOptions.useAddress===true&&place.formatted_address!=null)
html+='<p>'+place.formatted_address+'</p>';break;case 'description':if(settings.infoBoxHtmlOptions.useDescription===true&&items[idx].description!=null)
html+='<div class="description">'+items[idx].description+'</div>';break;case 'website':if(settings.infoBoxHtmlOptions.useWebsite===true&&items[idx].website!==null)
html+='<a class="website" href="'+items[idx].website+'" target="_blank">'+items[idx].website+'</a>';break;case 'rate':if(settings.infoBoxHtmlOptions.useRate===true&&items[idx].rate!=null)
html+='<i>from</i> $'+items[idx].rate+'/Night';break;}}});if(settings.infoBoxHtmlOptions.addDirections===true){var directionsType=settings.infoBoxHtmlOptions.directionsType;switch(directionsType){case 'form':html+='<div class="directions-links">'+
'<form class="directions">'+
'<input onblur="processLink()" type="text" name="address" id="address" maxlength="100" class="textfield" value="" />'+
'<a class="btn" target="_blank" href="#">Directions</a>'+
'</form>'+
'</div>';processLink=function(){var start=thisMap.find('.directions #address').val().replace(/\s/g,'+');var dirLink='http://maps.google.com/maps?saddr='+start+'&daddr='+items[idx].georss;$('.directions-links .btn').attr('href',dirLink);}
break;case 'link':default:html+='<div class="direction-links"> '+
'<a href="http://maps.google.com/maps?daddr='+items[idx].georss+'" target="_blank">Directions</a>'+
'</div>';break;}}
if(settings.infoBoxOptions.usePlacesData===true){if(place.rating!=undefined)
html+='<div>'+place.rating+'</div>';if(place.reviews!=undefined)
html+='<div>'+place.reviews+'</div>';if(place.url!=undefined)
html+='<div class="place-url"><a href="'+place.url+'"" target="_blank">places url</a></div>';if(place.icon!=undefined)
html+='<div class="place-icon"><img src="'+place.icon+'"></div>';if(place.international_phone_number!=undefined)
html+='<div class="intl-phone">'+place.international_phone_number+'</div>';}
html+='</div>';html+='</div>';return html;}
function getVisible(layer){var res=2;markers.forEach(function(marker,index){if(marker.pinID==layer.pinID){if(marker.show==true){res=1;}}});return(res==1)?true:false;}
function setVisible(layer,visible){markers.forEach(function(marker,index){if(marker.pinID==layer.pinID){if(visible==true){markers[index].show=true;layer.show=true;marker.addTo(map);}
if(visible==false){markers[index].show=false;layer.show=false;marker.remove();}}});}
function checkVisible(layer,i){markers.forEach(function(marker,index){if(marker.s!=undefined&&marker.s==true){return true;}else{return false;}});}
function uniqueArray(array){return $.grep(array,function(el,index){return index==$.inArray(el,array);});}});};})(jQuery);