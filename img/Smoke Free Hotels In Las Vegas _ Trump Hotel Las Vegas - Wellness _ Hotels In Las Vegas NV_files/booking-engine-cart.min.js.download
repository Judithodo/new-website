var myCart=function(l){"use strict";var e,r,a=!1,f={"@attributes":"",rooms:{}},m="new";function o(r){return l.Deferred(function(e){var t="/ajax/getcartdata";"new"!==(r=r||{weModifying:m}).weModifying&&(t="/ajax/getmodifycartdata",m=r.weModifying),l.ajax({type:"GET",url:t,cache:!1,success:function(t){if(void 0!==t.data&&"1"===t.data["@attributes"].success)return f=t.data.data,e.resolve(),!0;console.warn("Cart data not retrieved",t)},error:function(t){console.error("Couldn't get cart data",t)}})})}function b(){return f["@attributes"].currency}function i(){var t=l("nav.booking-steps"),e=getQueryVariable("startdate"),r=getQueryVariable("enddate"),a=[],o=0,i="",n=[],d=[],s="",c=y();switch(l.isEmptyObject(f.rooms)||(a=f.rooms.record),void 0===a.length&&(a=fixArray(f.rooms.record)),0<a.length&&(l("body").hasClass("roomlist")?"true"===getQueryVariable("modifying")&&"true"!==getQueryVariable("editmode")&&""!==getQueryVariable&&(void 0!==f["@attributes"].startdate&&(e=f["@attributes"].startdate),void 0!==f["@attributes"].enddate&&(r=f["@attributes"].enddate)):(void 0!==f["@attributes"].startdate&&(e=f["@attributes"].startdate),void 0!==f["@attributes"].enddate&&(r=f["@attributes"].enddate)),(o=parseInt(a.length,10))<2&&l.each(a,function(t,e){0<t&&(i+=", "),i+=e.name})),""===e||""===r||l("body").hasClass("calendar")?t.find("#your-stay label").text("Select Your Dates"):t.find("#your-stay label").text(moment(e).format("MMM DD, ddd")+" â€“ "+moment(r).format("MMM DD, ddd")),0<o?(1==o?t.find("#rooms .title").text(o+" Room"):t.find("#rooms .title").text(o+" Rooms"),t.find("#rooms label").text(i)):(t.find("#rooms .title").text("Rooms"),t.find("#rooms label").text("")),void 0!==a&&(l.each(a,function(t,e){l.isEmptyObject(e.packages)||(void 0===e.packages.record.length&&(e.packages.record=fixArray(e.packages.record)),l.each(e.packages.record,function(t,e){n.push(e)}))}),0<n.length&&(d=l.unique(n)),0<d.length?(l.each(d,function(t,e){0<t&&(s+=", "),s+=e.title}),1<d.length?t.find("#add-ons .title").text(d.length+" Add Ons"):t.find("#add-ons .title").text(d.length+" Add On"),d.length<2?t.find("#add-ons label").text(s):t.find("#add-ons label").text("")):(t.find("#add-ons .title").text("Add Ons"),t.find("#add-ons label").text(""))),m){case"modifying":t.find("#your-stay").attr("href","/booking?modifying=true&editmode=true&startdate="+c.startdate+"&enddate="+c.enddate+"&promocode="+c.promocode),t.find("#rooms").attr("href","/booking/roomlist?modifying=true&editmode=true"),t.find("#add-ons").attr("href","/booking/addons?modifying=true&editmode=true");break;default:if(t.find("#your-stay").attr("href","/booking?startdate="+c.startdate+"&enddate="+c.enddate+"&currency="+c.currency+"&adults="+c.totalAdults+"&children="+c.totalChildren+"&rooms="+c.totalRooms+"&promocode="+c.promocode),!l("body").hasClass("calendar")||!l("body").hasClass("roomlist")){var u="/booking/roomlist?startdate="+c.startdate+"&enddate="+c.enddate+"&currency="+c.currency+"&adults="+c.totalAdults+"&children="+c.totalChildren+"&rooms="+c.totalRooms;jQuery.isEmptyObject(f.rooms)||(void 0===f.rooms.record.length&&(f.rooms.record=fixArray(f.rooms.record)),jQuery.isEmptyObject(f.rooms.record[0].promocode)||(u+="&promocode="+f.rooms.record[0].promocode)),t.find("#rooms").attr("href",u)}t.find("#add-ons").attr("href","/booking/addons")}}function n(){l.isEmptyObject(f.rooms)?l("#cart").addClass("unclickable"):l("#cart").removeClass("unclickable"),r.text(formatCurrency(f["@attributes"].grandtotal,b()))}function t(){if(!l.isEmptyObject(f.rooms)){var r=0,o=[],t=[],a=0,i=0,n=0,d=0,s="",c="";for(var e in p(function(t){if(a+=parseFloat(t["@attributes"].subtotal),i+=parseFloat(t["@attributes"].fees),n+=parseFloat(t["@attributes"].taxes),!l.isEmptyObject(t.packages.record)){var e=t.packages.record;void 0===e.length&&(e=fixArray(t.packages.record)),l.each(e,function(t,e){d+=parseFloat(e["@attributes"].total)})}void 0===t.rate.days.record.length&&(t.rate.days.record=fixArray(t.rate.days.record)),l.each(t.rate.days.record,function(t,e){var r=e["@attributes"].date,a=e["@attributes"].price;o[r]?o[r]=parseFloat(Number(o[r])+Number(a)):o[r]=parseFloat(a)}),0<r?(c+=", "+t.name,s+=", "+t.rate.name):(c+=t.name,s+=t.rate.name),r++}),o)t.push({date:e,price:o[e]});return{rooms:parseFloat(a).toFixed(2),packages:parseFloat(d).toFixed(2),fees:parseFloat(i).toFixed(2),taxes:parseFloat(n).toFixed(2),total:parseFloat(a+i+n+d).toFixed(2),grandtotalusd:f["@attributes"].grandtotalusd,choosenRooms:c,choosenRates:s,byDayBreakdown:t}}}function d(){if(!l.isEmptyObject(f.rooms)){var t=new Date(convertDateStr(f["@attributes"].startdate,"/")),i=(new Date(convertDateStr(f["@attributes"].enddate,"/"))-t)/864e5;return f.rooms.record=isArray(f.rooms.record)?f.rooms.record:[f.rooms.record],{rooms:l.map(f.rooms.record,function(t){var r=[],e=parseFloat(Number(t["@attributes"].subtotal)/Number(i)).toFixed(2),a=parseFloat(t["@attributes"].discount),o=e;return 0<a&&(o=parseFloat((Number(t["@attributes"].subtotal)+a)/Number(i)).toFixed(2)),l.isEmptyObject(t.packages.record)||(void 0===(r=t.packages.record).length&&(r=fixArray(t.packages.record)),l.each(r,function(t,e){"Per person per night"!=e["@attributes"].type&&"Per person"!=e["@attributes"].type||(r[t].quantity=Math.ceil(parseInt(e["@attributes"].adults,10)+parseInt(e["@attributes"].children,10)))})),{cartId:+t["@attributes"].id,roomNum:+t["@attributes"].id+1,roomId:t["@attributes"].roomcode,rateCode:t["@attributes"].ratecode,roomName:t.name,rateInfo:t.rate,iata:t.iata,subtotal:parseFloat(t["@attributes"].subtotal).toFixed(2),adults:t["@attributes"].adults,children:t["@attributes"].children,averageRate:parseFloat(Number(t["@attributes"].subtotal)/Number(i)).toFixed(2),averageSlashRate:o,hasSlashRate:e<o,promocode:t.promocode,packages:r,modifyonline:!0}})}}return{rooms:[]}}function s(r){if(!l.isEmptyObject(f.rooms.record)){var t=new Date(convertDateStr(f["@attributes"].startdate,"/")),a=(new Date(convertDateStr(f["@attributes"].enddate,"/"))-t)/864e5,o=!0;return f.rooms.record=isArray(f.rooms.record)?f.rooms.record:[f.rooms.record],{rooms:l.map(f.rooms.record,function(t){if(t["@attributes"].id==r){var e=[];return l.isEmptyObject(t.packages.record)||void 0===(e=t.packages.record).length&&(e=fixArray(t.packages.record)),void 0!==t["@attributes"].modifyonline&&(o=t["@attributes"].modifyonline),void 0!==t["@attributes"].confirmation&&(o=t["@attributes"].confirmation),{cartId:parseInt(t["@attributes"].id,10),roomNum:parseInt(Math.ceil(t["@attributes"].id+1),10),roomId:t["@attributes"].roomcode,rateCode:t["@attributes"].ratecode,rateName:t.rate.name,roomName:t.name,iata:t.iata,subtotal:parseFloat(t["@attributes"].subtotal).toFixed(2),adults:t["@attributes"].adults,children:t["@attributes"].children,averageRate:parseFloat(Number(t["@attributes"].subtotal)/Number(a)).toFixed(2),promocode:t.promocode,packages:e,confirmation:"",modifyonline:o}}})}}return{rooms:[]}}function y(){var t=getQueryVariable("startdate"),e=getQueryVariable("enddate"),r=new Date(convertDateStr(getQueryVariable("startdate"),"-")),a=new Date(convertDateStr(getQueryVariable("enddate"),"-")),o=(a-r)/864e5,i=0,n=0,d=0,s="",c="",u=!0,m="";b();return void 0!==f["@attributes"].startdate&&(t=f["@attributes"].startdate,e=f["@attributes"].enddate,r=new Date(convertDateStr(t,"/")),o=((a=new Date(convertDateStr(e,"/")))-r)/864e5),getQueryVariable("adults")>i&&(i=getQueryVariable("adults")),getQueryVariable("children")>n&&(n=getQueryVariable("children")),getQueryVariable("rooms")>d&&(d=getQueryVariable("rooms")),void 0!==getQueryVariable("iata")&&(s=getQueryVariable("iata")),void 0!==getQueryVariable("promocode")&&(c=getQueryVariable("promocode")),l.isEmptyObject(f.rooms)||(d=n=i=0,p(function(t){i+=parseInt(t["@attributes"].adults,10),n+=parseInt(t["@attributes"].children,10),d+=1,void 0!==t["@attributes"].modifyonline&&(u=t["@attributes"].modifyonline),void 0!==t["@attributes"].confirmation&&(m=t["@attributes"].confirmation)})),{startdate:t,enddate:e,startString:moment(t).format("MMMM DD YYYY, dddd"),endString:moment(e).format("MMMM DD YYYY, dddd"),nights:o,totalAdults:i,totalChildren:n,totalRooms:d,iata:s,promocode:c,currency:b(),confirmation:m,modifyonline:u}}function c(){if(void 0!==f.formdata){var t=[];return l.isEmptyObject(f.formdata)||(t={firstname:f.formdata.firstname,lastname:f.formdata.lastname,email:f.formdata.email,phone:f.formdataphone,address1:f.formdata.address1,address2:f.formdata.address2,country:f.formdata.country,city:f.formdata.city,state:f.formdata.state,zipcode:f.formdata.zipcode,company:f.formdata.company}),t}return{formdata:[]}}function p(t){if("function"==typeof t)if(isArray(f.rooms.record))for(var e=0;e<f.rooms.record.length;e++)t(f.rooms.record[e],e);else t(f.rooms.record,0)}return{init:function(t){if("string"!=typeof t&&0!==t.indexOf("#"))throw new Error("myCart needs to be initialized with an id, eg.#cart-wrapper");if(!a){if(0===(e=l(t)).length)throw new Error("Failed to initialize the cart: There's no "+t+" on this step!");return a=!0,r=e.find("#cart .total"),i(),this}return console.warn("Trying to initialize myCart again. Already initialized with #"+e.attr("id")),this},getCartData:function(t){return l.when(o(t))},getRooms:function(){return d()},getRoom:function(t){return s(t)},getAddons:function(t){return e=s(t),r=[],a=[],l.isEmptyObject(e.rooms)?{packages:[]}:(l.isEmptyObject(e.rooms[0].packages)||(r=e.rooms[0].packages,a.packages=[],l.each(r,function(t,e){a.packages.push({id:e["@attributes"].id,quanity:Math.ceil(e["@attributes"].adults+e["@attributes"].children),code:e["@attributes"].code,total:e["@attributes"].total,startdate:e["@attributes"].startdate,type:e["@attributes"].type,title:e.title})})),a);var e,r,a},getStayInfo:function(){return y()},getSubtotal:function(){return t()},updateSteps:function(){return i()},getFormData:function(){return c()},getCartStatus:function(){return m},getCartView:function(){if(void 0!==typeof f["@attributes"]){return{stayInfo:y(),roomsInfo:d(),subtotal:t(),formdata:c(),cartState:m}}return{cartview:[]}},getCurrency:function(){return b()},update:function(t){return(t=t||{withAjax:!1}).withAjax?l.when(o()).then(function(){n(),i()}):(n(),i()),this},remove:function(t){var a;return 1===arguments.length?l.when((a=t,l.Deferred(function(e){var t=myCart.getRoom(a),r=y();t=t.rooms[0],console.log(t),console.log(r),l.ajax({type:"GET",url:"/ajax/removeroomfromcart?id="+a,cache:!1,success:function(t){console.log("Removed from cart",t),f=t.data.data,l.when(o()).then(function(){n(),i()}),e.resolve()},error:function(t){console.error("Couldn't remove from cart",t),e.reject()}})}))).then(function(){l("body").find(".loading-overlay").remove()}):l("body .loading-overlay").remove(),this},removeAll:function(t){return t=t||{refresh:!1},_removeAllFromCart().then(function(){t.refresh?window.location.href=window.location.href.replace("&clearrooms",""):n()}),this}}}(jQuery,document.getElementById("cart-wrapper"));